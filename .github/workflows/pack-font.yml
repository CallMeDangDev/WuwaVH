name: Pack Font

on:
  workflow_dispatch:
    inputs:
      font_url:
        description: 'Direct download link to the TTF font file'
        required: true
        type: string
      output_name:
        description: 'Output .pak file name (without extension)'
        required: false
        default: 'VongXuyen_100_P'
        type: string

jobs:
  pack-font:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download repak
        shell: pwsh
        run: |
          # Get latest repak release URL
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/trumank/repak/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -eq "repak_cli-x86_64-pc-windows-msvc.zip" }
          $downloadUrl = $asset.browser_download_url

          Write-Host "Downloading repak from: $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "repak.zip"

          # Extract repak
          Expand-Archive -Path "repak.zip" -DestinationPath "repak" -Force
          Remove-Item "repak.zip"

          # Verify repak exists
          if (Test-Path "repak\repak.exe") {
            Write-Host "repak.exe ready"
          } else {
            Write-Error "repak.exe not found after extraction"
            exit 1
          }

      - name: Download font and prepare files
        shell: pwsh
        run: |
          $fontDir = "Fonts\Client\Content\Aki\UI\Framework\LGUI\Font"

          # Ensure directory exists
          New-Item -ItemType Directory -Path $fontDir -Force | Out-Null

          # Download font
          $fontUrl = "${{ inputs.font_url }}"
          Write-Host "Downloading font from: $fontUrl"
          Invoke-WebRequest -Uri $fontUrl -OutFile "$fontDir\LaguSansBold.ufont"

          # Verify download
          $fileSize = (Get-Item "$fontDir\LaguSansBold.ufont").Length
          Write-Host "Font downloaded: $fileSize bytes"

          if ($fileSize -eq 0) {
            Write-Error "Downloaded font file is empty"
            exit 1
          }

          # List contents for verification
          Write-Host "`nFont directory contents:"
          Get-ChildItem -Path $fontDir | Format-Table Name, Length -AutoSize

      - name: Pack into .pak
        shell: pwsh
        run: |
          $repak = "repak\repak.exe"
          $inputFolder = "Fonts\Client"
          $outputPak = "Fonts\${{ inputs.output_name }}.pak"

          Write-Host "Packing $inputFolder -> $outputPak"
          & $repak pack -v --version V12 $inputFolder -- $outputPak

          if ($LASTEXITCODE -ne 0) {
            Write-Error "repak pack failed with exit code $LASTEXITCODE"
            exit 1
          }

          $pakSize = (Get-Item $outputPak).Length
          Write-Host "Pack complete: $outputPak ($pakSize bytes)"

      - name: Upload .pak artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.output_name }}
          path: Fonts/${{ inputs.output_name }}.pak
          retention-days: 30
