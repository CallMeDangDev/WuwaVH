name: Pack Font

on:
  workflow_dispatch:
    inputs:
      font_url:
        description: 'Direct download link to the TTF font file'
        required: true
        type: string
      output_name:
        description: 'Output .pak file name (without extension)'
        required: false
        default: 'VongXuyen_100_P'
        type: string

jobs:
  pack-font:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download font and prepare files
        shell: pwsh
        run: |
          $fontDir = "Fonts\Fonts\Client\Content\Aki\UI\Framework\LGUI\Font"

          # Ensure directory exists
          New-Item -ItemType Directory -Path $fontDir -Force | Out-Null

          # Download font
          $fontUrl = "${{ inputs.font_url }}"
          Write-Host "Downloading font from: $fontUrl"
          Invoke-WebRequest -Uri $fontUrl -OutFile "$fontDir\LaguSansBold.ufont"

          # Verify download
          $fileSize = (Get-Item "$fontDir\LaguSansBold.ufont").Length
          Write-Host "Font downloaded: $fileSize bytes"

          if ($fileSize -eq 0) {
            Write-Error "Downloaded font file is empty"
            exit 1
          }

          # List contents for verification
          Write-Host "`nFont directory contents:"
          Get-ChildItem -Path $fontDir | Format-Table Name, Length -AutoSize

      - name: Pack into .pak
        shell: pwsh
        run: |
          $repak = ".\Fonts\repak.exe"
          $inputFolder = "Fonts\Fonts"
          $outputPak = "Fonts\${{ inputs.output_name }}.pak"

          Write-Host "Packing $inputFolder -> $outputPak"
          & $repak pack -v --version V12 $inputFolder -- $outputPak

          if ($LASTEXITCODE -ne 0) {
            Write-Error "repak pack failed with exit code $LASTEXITCODE"
            exit 1
          }

          $pakSize = (Get-Item $outputPak).Length
          Write-Host "Pack complete: $outputPak ($pakSize bytes)"

      - name: Upload .pak artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.output_name }}
          path: Fonts/${{ inputs.output_name }}.pak
          retention-days: 30
